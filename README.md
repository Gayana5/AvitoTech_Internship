# PR Reviewer Assignment Service

Сервис для автоматического назначения ревьюверов на Pull Request'ы.

## Описание

Микросервис, который автоматически назначает ревьюверов на PR из команды автора, позволяет выполнять переназначение ревьюверов и получать список PR'ов, назначенных конкретному пользователю, а также управлять командами и активностью пользователей.

## Технологии

- **Язык**: Go 1.21+
- **База данных**: PostgreSQL 15
- **HTTP фреймворк**: Gorilla Mux

## Быстрый старт

### Требования

- Docker и Docker Compose
- Go 1.21+ (для локальной разработки)

### Запуск с Docker Compose

Самый простой способ запустить сервис:

```bash
docker-compose up
```

Сервис будет доступен на `http://localhost:8080`.

Миграции базы данных применяются автоматически при запуске сервиса.

### Локальная разработка

1. Убедитесь, что PostgreSQL запущен и доступен:
   ```bash
   # Запустите PostgreSQL локально или используйте Docker
   docker run -d --name postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=pr_reviewer -p 5432:5432 postgres:15-alpine
   ```

2. Установите зависимости:
   ```bash
   make deps
   # или
   go mod download
   ```

3. Запустите сервис:
   ```bash
   make run
   # или
   go run ./cmd/server
   ```

4. Сервис будет доступен на `http://localhost:8080`

## API Endpoints

### Команды

- `POST /team/add` - Создать команду с участниками
- `GET /team/get?team_name=<name>` - Получить команду с участниками

### Пользователи

- `POST /users/setIsActive` - Установить флаг активности пользователя
- `GET /users/getReview?user_id=<id>` - Получить PR'ы, где пользователь назначен ревьювером
- `POST /users/bulkDeactivate` - Массовая деактивация пользователей команды (опциональная функция)

### Pull Requests

- `POST /pullRequest/create` - Создать PR и автоматически назначить до 2 ревьюверов
- `POST /pullRequest/merge` - Пометить PR как MERGED (идемпотентная операция)
- `POST /pullRequest/reassign` - Переназначить конкретного ревьювера

### Дополнительные

- `GET /health` - Проверка здоровья сервиса
- `GET /stats` - Статистика по назначениям и PR (опциональная функция)

## Примеры использования

### Создание команды

```bash
curl -X POST http://localhost:8080/team/add \
  -H "Content-Type: application/json" \
  -d '{
    "team_name": "backend",
    "members": [
      {"user_id": "u1", "username": "Alice", "is_active": true},
      {"user_id": "u2", "username": "Bob", "is_active": true}
    ]
  }'
```

### Создание PR

```bash
curl -X POST http://localhost:8080/pullRequest/create \
  -H "Content-Type: application/json" \
  -d '{
    "pull_request_id": "pr-1001",
    "pull_request_name": "Add search feature",
    "author_id": "u1"
  }'
```

### Получение статистики

```bash
curl http://localhost:8080/stats
```

## Makefile команды

- `make build` - Собрать приложение
- `make run` - Запустить приложение локально
- `make test` - Запустить тесты
- `make docker-build` - Собрать Docker образ
- `make docker-up` - Запустить сервисы через Docker Compose
- `make docker-down` - Остановить сервисы
- `make docker-logs` - Просмотр логов
- `make deps` - Установить зависимости

## Тестирование

### Unit и интеграционные тесты

```bash
make test
# или
go test ./...
```

Для интеграционных тестов требуется доступ к тестовой базе данных. По умолчанию используется `pr_reviewer_test`. Можно задать через переменную окружения:

```bash
TEST_DATABASE_URL=postgres://user:pass@localhost:5432/test_db?sslmode=disable make test
```

## Структура проекта

```
.
├── cmd/
│   └── server/
│       └── main.go          # Точка входа приложения
├── internal/
│   ├── database/
│   │   └── database.go      # Подключение к БД и миграции
│   ├── handlers/
│   │   └── handlers.go      # HTTP handlers
│   ├── models/
│   │   └── models.go        # Модели данных
│   └── service/
│       ├── service.go       # Основная бизнес-логика
│       ├── stats.go         # Статистика
│       ├── bulk_deactivate.go # Массовая деактивация
│       └── service_test.go  # Тесты
├── docker-compose.yml       # Docker Compose конфигурация
├── Dockerfile              # Docker образ
├── Makefile                # Команды сборки
├── go.mod                  # Go модули
└── README.md               # Документация
```

## Принятые решения и допущения

### 1. Обработка ошибок

Ошибки возвращаются в формате, указанном в OpenAPI спецификации:
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Error message"
  }
}
```

### 2. Случайный выбор ревьюверов

При назначении ревьюверов используется случайный выбор из доступных активных участников команды. Используется стандартный пакет `math/rand` Go.

### 3. Идемпотентность merge

Операция merge является идемпотентной - повторный вызов не приводит к ошибке и возвращает актуальное состояние PR.

### 4. Переназначение ревьюверов

При переназначении новый ревьювер выбирается случайным образом из активных участников команды заменяемого ревьювера, исключая:
- Самого заменяемого ревьювера
- Уже назначенных ревьюверов на этот PR
- Неактивных пользователей

### 5. Массовая деактивация

При массовой деактивации пользователей автоматически выполняется безопасное переназначение открытых PR, где деактивированные пользователи были назначены ревьюверами. Это помогает поддерживать актуальность назначений.

### 6. Производительность

- Используются индексы на часто запрашиваемых полях
- Транзакции используются для обеспечения консистентности данных
- Запросы оптимизированы для работы с умеренными объемами данных (до 20 команд, до 200 пользователей)

## Конфигурация

Сервис использует переменные окружения:

- `DATABASE_URL` - строка подключения к PostgreSQL (по умолчанию: `postgres://postgres:postgres@localhost:5432/pr_reviewer?sslmode=disable`)
- `PORT` - порт для HTTP сервера (по умолчанию: `8080`)

## Производительность

Сервис разработан для работы с умеренными объемами данных:
- До 20 команд
- До 200 пользователей
- RPS: 5
- SLI времени ответа: 300 мс
- SLI успешности: 99.9%

## Дополнительные функции

Реализованы следующие опциональные функции:

1. **Статистика** (`GET /stats`) - показывает:
   - Статистику назначений по пользователям
   - Общую статистику по PR (открытые, закрытые, с ревьюверами и без)

2. **Массовая деактивация** (`POST /users/bulkDeactivate`) - позволяет:
   - Деактивировать несколько пользователей команды за один запрос
   - Автоматически переназначать открытые PR, где деактивированные пользователи были ревьюверами
   - Целевое время выполнения: < 100 мс для средних объемов данных

3. **Интеграционные тесты** - покрывают основные сценарии использования

## Лицензия

Тестовое задание для стажировки в Avito Tech.
